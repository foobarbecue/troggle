{% extends "admin/change_form.html" %}
{% load i18n admin_modify adminmedia %}

{% block bodyclass %}{{ opts.app_label }}-{{ opts.object_name.lower }} change-form{% endblock %}
{% block coltype %}{% if ordered_objects %}colMS{% else %}colM{% endif %}{% endblock %}

{% block extrahead %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% admin_media_prefix %}css/forms.css" />

<script type="text/javascript" src="../../../jsi18n/"></script>
<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}jquery-1.3.min.js"></script>
<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}jquery.ui.all.js"></script>
<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}jquery.livequery.js"></script>
<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}jquery.alerts.js"></script>

<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}helper.js"></script>
<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}listener.js"></script>

<script type="text/javascript" src="/media/sys/feinheit/tinymce/tiny_mce.js"></script>

<script type="text/javascript">

    tinyMCE.init({
        mode: "none",
        theme: "advanced",
        language: "en",
        theme_advanced_toolbar_location: "top",
        theme_advanced_toolbar_align: "left",
        theme_advanced_statusbar_location: "bottom",
        theme_advanced_buttons1: "fullscreen,|,formatselect,image,media,code,|,cut,copy,paste,|,bold,italic,|,bullist,numlist,|,link,unlink",
        theme_advanced_buttons2: "",
        theme_advanced_buttons3: "",
        theme_advanced_path: false,
        theme_advanced_blockformats: "p,h2,h3",
        theme_advanced_resizing: true,
        width: '600',
        height: '300',
        content_css: "/path_to_your_media/css/preview.css",
        plugins: "advimage,advlink,fullscreen,table,preview,media,inlinepopups",
        advimage_update_dimensions_onchange: true,
        //file_browser_callback: "CustomFileBrowser",
        relative_urls: false
    });

    function init_pagecontent() {
        // handle special page content type needs
        // this is not really extensible, but it works for now
        $('.order-machine textarea[name*=richtext]:visible').each(function(){
            tinyMCE.execCommand('mceAddControl', true, this.id);
        });
    }

    IMG_ARROW_DOWN_PATH = "{{ FEINCMS_ADMIN_MEDIA }}img/arrow_down.gif";
    IMG_ARROW_RIGHT_PATH = "{{ FEINCMS_ADMIN_MEDIA }}img/arrow_right.gif";
    IMG_CIRCLE_PATH = "{{ FEINCMS_ADMIN_MEDIA }}img/circle.gif";
    IMG_DELETELINK_PATH = "{{ FEINCMS_ADMIN_MEDIA }}img/icon_deletelink.gif";
    IMG_MOVE_PATH = "{{ FEINCMS_ADMIN_MEDIA }}img/icon_move.gif";

    REGIONS = [];
    REGION_MAP = [];
    {% for region in page.template.regions.all %}
        REGIONS.push('{{ region.key }}');
        REGION_MAP.push('{{ region.id }}');
    {% endfor %}
    ACTIVE_REGION = 0;

    CONTENT_NAMES = {
        {% for name, value in content_types %}'{{ value }}': '{{ name }}'{% if not forloop.last %},{% endif %}
        {% endfor %}};

    $(document).ready(function(){
        // move contents into their corresponding regions and do some simple formatting
        $("div[id$=_set]").children().each(function(){
            if (!($(this).hasClass("header"))) {
                $(this).find("select[name$=region]").addClass("region-choice-field").parents("tr").hide();
                $(this).find("input[name$=DELETE]").addClass("delete-field").parents("tr").hide();
                $(this).find("input[name$=ordering]").addClass("order-field").parents("tr").hide();
                $(this).find("input[name$=id]").hide().prev().hide();
                $(this).find("input[name$=parent]").hide().prev().hide();

                var region_id = $(this).find(".region-choice-field").val();
                region_id = REGION_MAP.indexOf(region_id);
                var content_type = $(this).attr("id").substr(0, $(this).attr("id").indexOf("_"));
                region_append(region_id,$(this), CONTENT_NAMES[content_type]);
                set_item_field_value($(this),"region-choice-field",region_id)
            }
        });
        // register regions as sortable for drag N drop
        $(".order-machine").sortable({
            handle: '.handle',
            helper: 'clone',
            stop: function(event, ui) {
                richify_poor($(ui.item));
            }
        });
        // hide content on drag n drop
        $(".handle").mousedown(function(){
            poorify_rich($(this).parents(".order-item"));
        });
        $(".handle").mouseup(function(){
            richify_poor($(this).parents(".order-item"));
        });
        // convert text areas to rich text editors.
        init_pagecontent();

        if(window.location.hash) {
            $(window.location.hash+'_tab').trigger('click');
        }

        // bring order to chaos
        zucht_und_ordnung(true);

        {% block extra-init-js %}{% endblock %}
    });
</script>

<link rel="stylesheet" type="text/css" href="{{ FEINCMS_ADMIN_MEDIA }}css/layout.css" />
<link rel="stylesheet" type="text/css" href="{{ FEINCMS_ADMIN_MEDIA }}css/jquery.alerts.css" media="screen" />

{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
     <a href="../../../">{% trans "Home" %}</a> &rsaquo;
     <a href="../../">{{ opts.app_label|capfirst|escape }}</a> &rsaquo;
     <a href="../">{{ opts.verbose_name_plural|capfirst }}</a> &rsaquo;
     {{ page.title|truncatewords:"18" }}
</div>
{% endblock %}

{% block content %}

<div id="content-main">

{% block object-tools %}
<ul class="object-tools">
    {% if page.get_absolute_url %}
        <li><a target="_blank" href="{{ page.get_absolute_url }}" class="viewsitelink">{% trans "View on site" %}</a></li>
    {% endif %}
</ul>
{% endblock %}

<hr/>

<form name="main_form" enctype="multipart/form-data" action="." method="post" id="{{ opts.module_name }}_form">

<div id="overview">
    <p style="float:right;" class="deletelink-box"><a href="delete/" class="deletelink">{% trans "Delete" %}</a></p>
    {% for field in top_fieldset %}
        {{ field.label_tag }}
        <span>{{ field }}{{ field.errors }}</span>
    {% endfor %}
    <input type="submit" class="submit_form" value="{% trans 'Save' %}" />
    <hr/>
    {{ page_form.template.label_tag }}
    <span>{{ page_form.template }}{{ page_form.template.errors }}</span>
    <input type="button" class="cancel" value="{% trans 'Change Template' %}" />
    <hr/>
</div>
<div id="main_wrapper">
    <div class="navi_tab tab_active" id="settings_tab">Settings</div>
    {% for region in page.template.regions.all %}<div class="navi_tab tab_inactive" id="{{ region.key }}_tab">{{ region.title }}</div>{% endfor %}
    <div id="main">
        <div id="settings_body">
            <table>
                {{ settings_fieldset.as_table }}
            </table>
        </div>
        {% for region in page.template.regions.all %}
        <div id="{{ region.key }}_body" class="panel">
            <div class="empty-machine-msg">
                {% trans "Region empty" %}
            </div>
            <div class="empty-machine-msg" style="margin-left:20px; margin-top:20px;">
                {% if region.inherited %}
                    {% trans "Content from the parent site is automatically inherited. To override this behaviour, add some content." %}
                {% endif %}
            </div>
            <div class="order-machine">

            </div>

            <div class="machine-control">
                <div class="control-unit">
                    <span>Add New item:</span> <br/>
                    <select name="order-machine-add-select">
                    {% for n,v  in content_types %} <option value="{{ v }}">{{ n }}</option> {% endfor %}
                    </select>
                    <input type="button" class="order-machine-add-button button" value="OK" />
                </div>
                <div class="control-unit">
                    <span>Move selected item to:</span>  <br/>
                    <select name="order-machine-move-select">
                    {% for r in page.template.regions.all %} {% ifnotequal region r %} <option value="{{ r.key }}">{{ r.title }}</option> {% endifnotequal %} {% endfor %}
                    </select>
                    <input type="button" class="order-machine-move-button button" value="OK" />
                </div>
            </div>
         </div>
        {% endfor %}
    </div>
</div>


<div id="inlines" style="display:none">
{% for formset in inline_formsets %}
    <div id="{{ formset.rel_name }}">
        <div class="header">
            {{ formset.management_form }}
            <h3>{{ formset.rel_name }}</h3>
        </div>
        {% for form in formset.forms %}
            <div id="{{ formset.rel_name }}_item_{{ forloop.counter0 }}">
            <table>
            {{ form.as_table }}
            </table>
            </div>
        {% endfor %}
    </div>
{% endfor %}
</div>

</form>

</div>
{% endblock %}

